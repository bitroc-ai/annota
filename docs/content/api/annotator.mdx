# Annotator Instance

The annotator instance provides programmatic access to annotations, layers, selection, and events.

## Getting the Instance

Access the annotator instance using the `useAnnotator` hook:

```tsx
import { useAnnotator } from 'annota';

function MyComponent() {
  const annotator = useAnnotator();

  // Use annotator methods
  const handleAddAnnotation = () => {
    annotator?.addAnnotation({
      id: 'ann-1',
      shape: { type: 'point', point: { x: 100, y: 100 }, bounds: {...} },
    });
  };

  return <button onClick={handleAddAnnotation}>Add Annotation</button>;
}
```

## Interface

```typescript
interface OpenSeadragonAnnotator {
  // Annotation CRUD
  addAnnotation(annotation: Annotation): void;
  addAnnotations(annotations: Annotation[]): void;
  updateAnnotation(id: string, updates: Partial<Annotation>): void;
  deleteAnnotation(id: string): void;
  removeAnnotation(id: string): void;  // Alias for deleteAnnotation
  clearAnnotations(): void;
  getAnnotation(id: string): Annotation | undefined;
  getAnnotations(): Annotation[];

  // Spatial queries
  getAnnotationsInBounds(bounds: Bounds): Annotation[];

  // Selection
  setSelected(id: string | string[]): void;
  getSelected(): string[];

  // Layer management
  createLayer(config: LayerConfig): void;
  getLayer(id: string): Layer | undefined;
  getAllLayers(): Layer[];
  updateLayer(id: string, updates: Partial<Layer>): void;
  deleteLayer(id: string, deleteAnnotations?: boolean): void;
  setLayerVisibility(id: string, visible: boolean): void;
  setLayerLocked(id: string, locked: boolean): void;
  setLayerOpacity(id: string, opacity: number): void;
  setLayerZIndex(id: string, zIndex: number): void;

  // Rendering
  setStyle(style: StyleExpression): void;
  setFilter(filter: ((annotation: Annotation) => boolean) | null): void;
  setVisible(visible: boolean): void;

  // History/Undo-Redo
  undo(): void;
  redo(): void;
  canUndo(): boolean;
  canRedo(): boolean;
  clearHistory(): void;

  // Events
  on(event: AnnotatorEvent, handler: AnnotatorEventHandler): void;
  off(event: AnnotatorEvent, handler: AnnotatorEventHandler): void;
  emit(event: AnnotatorEvent, data: any): void;

  // Lifecycle
  destroy(): void;

  // Internal state (read-only access)
  state: {
    store: AnnotationStore;
    layerManager: LayerManager;
  };
}
```

## Annotation CRUD Operations

### addAnnotation

Add a single annotation.

```typescript
addAnnotation(annotation: Annotation): void
```

**Example:**

```tsx
annotator.addAnnotation({
  id: 'ann-1',
  shape: {
    type: 'point',
    point: { x: 500, y: 300 },
    bounds: { minX: 500, minY: 300, maxX: 500, maxY: 300 },
  },
  properties: {
    type: 'cell',
    layer: 'default',
  },
  style: {
    fill: '#FF0000',
    fillOpacity: 0.8,
  },
});
```

### addAnnotations

Add multiple annotations at once (more efficient than multiple `addAnnotation` calls).

```typescript
addAnnotations(annotations: Annotation[]): void
```

**Example:**

```tsx
const annotations = [
  { id: 'ann-1', shape: {...}, properties: {...} },
  { id: 'ann-2', shape: {...}, properties: {...} },
  { id: 'ann-3', shape: {...}, properties: {...} },
];

annotator.addAnnotations(annotations);
```

### updateAnnotation

Update an existing annotation.

```typescript
updateAnnotation(id: string, updates: Partial<Annotation>): void
```

**Example:**

```tsx
// Update properties
annotator.updateAnnotation('ann-1', {
  properties: {
    type: 'tumor',
    confidence: 0.95,
  },
});

// Update style
annotator.updateAnnotation('ann-1', {
  style: {
    fill: '#00FF00',
    fillOpacity: 0.5,
  },
});

// Update shape (for editing)
annotator.updateAnnotation('ann-1', {
  shape: {
    type: 'rectangle',
    x: 100,
    y: 100,
    width: 200,
    height: 150,
    bounds: { minX: 100, minY: 100, maxX: 300, maxY: 250 },
  },
});
```

### deleteAnnotation

Delete an annotation by ID.

```typescript
deleteAnnotation(id: string): void
```

**Example:**

```tsx
annotator.deleteAnnotation('ann-1');
```

### removeAnnotation

Alias for `deleteAnnotation`.

```typescript
removeAnnotation(id: string): void
```

### getAnnotation

Get a specific annotation by ID.

```typescript
getAnnotation(id: string): Annotation | undefined
```

**Example:**

```tsx
const annotation = annotator.getAnnotation('ann-1');
if (annotation) {
  console.log('Found annotation:', annotation);
}
```

### getAnnotations

Get all annotations.

```typescript
getAnnotations(): Annotation[]
```

**Example:**

```tsx
const allAnnotations = annotator.getAnnotations();
console.log(`Total annotations: ${allAnnotations.length}`);
```

### clearAnnotations

Remove all annotations from the store.

```typescript
clearAnnotations(): void
```

**Example:**

```tsx
// Clear all annotations
annotator.clearAnnotations();
```

## Spatial Queries

### getAnnotationsInBounds

Get all annotations within a bounding box (uses R-tree for fast queries).

```typescript
getAnnotationsInBounds(bounds: Bounds): Annotation[]
```

**Parameters:**

```typescript
interface Bounds {
  minX: number;
  minY: number;
  maxX: number;
  maxY: number;
}
```

**Example:**

```tsx
// Get annotations in a specific region
const annotations = annotator.getAnnotationsInBounds({
  minX: 0,
  minY: 0,
  maxX: 1000,
  maxY: 1000,
});

console.log(`Found ${annotations.length} annotations in region`);
```

## Selection Management

### setSelected

Set the selected annotation(s).

```typescript
setSelected(id: string | string[]): void
```

**Examples:**

```tsx
// Select single annotation
annotator.setSelected('ann-1');

// Select multiple annotations
annotator.setSelected(['ann-1', 'ann-2', 'ann-3']);

// Clear selection
annotator.setSelected([]);
```

### getSelected

Get currently selected annotation IDs.

```typescript
getSelected(): string[]
```

**Example:**

```tsx
const selectedIds = annotator.getSelected();
console.log(`Selected: ${selectedIds.length} annotations`);
```

## Layer Management

### createLayer

Create a new layer.

```typescript
createLayer(config: LayerConfig): void
```

**Parameters:**

```typescript
interface LayerConfig {
  id: string;
  name: string;
  visible?: boolean;   // Default: true
  locked?: boolean;    // Default: false
  opacity?: number;    // Default: 1 (0-1 range)
  zIndex?: number;     // Default: 0
  filter?: (annotation: Annotation) => boolean;
}
```

**Example:**

```tsx
annotator.createLayer({
  id: 'tumor',
  name: 'Tumor Annotations',
  visible: true,
  locked: false,
  opacity: 1,
  zIndex: 10,
});
```

### getLayer

Get a layer by ID.

```typescript
getLayer(id: string): Layer | undefined
```

**Example:**

```tsx
const layer = annotator.getLayer('tumor');
if (layer) {
  console.log(`Layer: ${layer.name}, visible: ${layer.visible}`);
}
```

### getAllLayers

Get all layers.

```typescript
getAllLayers(): Layer[]
```

**Example:**

```tsx
const layers = annotator.getAllLayers();
console.log(`Total layers: ${layers.length}`);
```

### updateLayer

Update layer properties.

```typescript
updateLayer(id: string, updates: Partial<Layer>): void
```

**Example:**

```tsx
annotator.updateLayer('tumor', {
  name: 'Cancer Regions',
  opacity: 0.5,
});
```

### deleteLayer

Delete a layer and optionally its annotations.

```typescript
deleteLayer(id: string, deleteAnnotations?: boolean): void
```

**Parameters:**
- `id`: Layer ID to delete
- `deleteAnnotations`: If true, also delete all annotations on this layer (default: false)

**Example:**

```tsx
// Delete layer but keep annotations
annotator.deleteLayer('tumor');

// Delete layer and all its annotations
annotator.deleteLayer('tumor', true);
```

### setLayerVisibility

Toggle layer visibility.

```typescript
setLayerVisibility(id: string, visible: boolean): void
```

**Example:**

```tsx
annotator.setLayerVisibility('tumor', false);
```

### setLayerLocked

Lock or unlock a layer (prevents editing).

```typescript
setLayerLocked(id: string, locked: boolean): void
```

**Example:**

```tsx
annotator.setLayerLocked('tumor', true);
```

### setLayerOpacity

Set layer opacity.

```typescript
setLayerOpacity(id: string, opacity: number): void
```

**Parameters:**
- `opacity`: Value between 0 (transparent) and 1 (opaque)

**Example:**

```tsx
annotator.setLayerOpacity('tumor', 0.5);
```

### setLayerZIndex

Set layer z-index (rendering order).

```typescript
setLayerZIndex(id: string, zIndex: number): void
```

**Example:**

```tsx
// Higher z-index renders on top
annotator.setLayerZIndex('tumor', 100);
annotator.setLayerZIndex('background', 0);
```

## Rendering Control

### setStyle

Set the global style function for annotations.

```typescript
setStyle(style: StyleExpression): void

type StyleExpression = AnnotationStyle | ((annotation: Annotation) => AnnotationStyle);
```

**Example:**

```tsx
// Static style
annotator.setStyle({
  fill: '#FF0000',
  fillOpacity: 0.3,
  stroke: '#FFFFFF',
  strokeWidth: 2,
});

// Dynamic style function
annotator.setStyle((annotation) => ({
  fill: annotation.properties?.type === 'tumor' ? '#FF0000' : '#00FF00',
  fillOpacity: 0.3,
  stroke: '#FFFFFF',
  strokeWidth: 2,
}));
```

### setFilter

Filter which annotations are visible.

```typescript
setFilter(filter: ((annotation: Annotation) => boolean) | null): void
```

**Example:**

```tsx
// Only show annotations with type 'tumor'
annotator.setFilter((annotation) =>
  annotation.properties?.type === 'tumor'
);

// Clear filter (show all)
annotator.setFilter(null);
```

### setVisible

Toggle visibility of all annotations.

```typescript
setVisible(visible: boolean): void
```

**Example:**

```tsx
// Hide all annotations
annotator.setVisible(false);

// Show all annotations
annotator.setVisible(true);
```

## History & Undo/Redo

### undo

Undo the last operation.

```typescript
undo(): void
```

**Example:**

```tsx
annotator.undo();
```

### redo

Redo the last undone operation.

```typescript
redo(): void
```

**Example:**

```tsx
annotator.redo();
```

### canUndo

Check if undo is available.

```typescript
canUndo(): boolean
```

**Example:**

```tsx
const undoAvailable = annotator.canUndo();

<button disabled={!undoAvailable} onClick={() => annotator.undo()}>
  Undo
</button>
```

### canRedo

Check if redo is available.

```typescript
canRedo(): boolean
```

**Example:**

```tsx
const redoAvailable = annotator.canRedo();

<button disabled={!redoAvailable} onClick={() => annotator.redo()}>
  Redo
</button>
```

### clearHistory

Clear the entire undo/redo history.

```typescript
clearHistory(): void
```

**Example:**

```tsx
// Clear history after saving
annotator.clearHistory();
```

## Event System

### on

Register an event handler.

```typescript
on(event: AnnotatorEvent, handler: AnnotatorEventHandler): void
```

**Event types:**

```typescript
type AnnotatorEvent =
  | 'createAnnotation'
  | 'updateAnnotation'
  | 'deleteAnnotation'
  | 'selectionChanged';
```

**Example:**

```tsx
const handleCreate = (annotation: Annotation) => {
  console.log('Created:', annotation.id);
};

annotator.on('createAnnotation', handleCreate);
```

### off

Remove an event handler.

```typescript
off(event: AnnotatorEvent, handler: AnnotatorEventHandler): void
```

**Example:**

```tsx
annotator.off('createAnnotation', handleCreate);
```

### emit

Emit a custom event (primarily for internal use).

```typescript
emit(event: AnnotatorEvent, data: any): void
```

**Example:**

```tsx
// Manually trigger selection changed event
annotator.emit('selectionChanged', { selected: ['ann-1', 'ann-2'] });
```

## Lifecycle

### destroy

Clean up the annotator instance and remove all event listeners.

```typescript
destroy(): void
```

**Example:**

```tsx
useEffect(() => {
  // Create annotator
  const annotator = createAnnotator(viewer);

  return () => {
    // Clean up on unmount
    annotator.destroy();
  };
}, [viewer]);
```

## Internal State

The annotator exposes internal state for advanced use cases:

### state.store

Access the annotation store directly:

```typescript
interface AnnotationStore {
  add(annotation: Annotation): void;
  update(id: string, updates: Partial<Annotation>): void;
  delete(id: string): void;
  get(id: string): Annotation | undefined;
  all(): Annotation[];
  search(bounds: Bounds): Annotation[];
  subscribe(callback: () => void): () => void;
}
```

**Example:**

```tsx
// Direct store access
const allAnnotations = annotator.state.store.all();

// Subscribe to store changes
const unsubscribe = annotator.state.store.subscribe(() => {
  console.log('Store updated');
});
```

### state.layerManager

Access the layer manager directly:

```typescript
const layers = annotator.state.layerManager.getAllLayers();
console.log(`Layers: ${layers.length}`);
```

## Usage Patterns

### Batch Operations

For better performance, batch operations:

```tsx
// ✅ Good - single batch operation
annotator.addAnnotations([ann1, ann2, ann3]);

// ❌ Avoid - multiple separate operations
annotator.addAnnotation(ann1);
annotator.addAnnotation(ann2);
annotator.addAnnotation(ann3);
```

### Event Cleanup

Always clean up event listeners:

```tsx
useEffect(() => {
  if (!annotator) return;

  const handler = (annotation: Annotation) => {
    console.log('Created:', annotation);
  };

  annotator.on('createAnnotation', handler);

  return () => {
    annotator.off('createAnnotation', handler);
  };
}, [annotator]);
```

### Conditional Updates

Check if annotation exists before updating:

```tsx
const annotation = annotator.getAnnotation('ann-1');
if (annotation) {
  annotator.updateAnnotation('ann-1', { properties: { type: 'tumor' } });
}
```

## Next Steps

- [React Hooks](/api/hooks) - Use hooks instead of direct instance access
- [Events Guide](/docs/guides/events) - Event system details
- [TypeScript Types](/api/types) - Type definitions
