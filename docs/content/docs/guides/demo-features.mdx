# Demo Application

The Annota demo app showcases key features including OpenCV-powered cell edge detection.

## Features

### 1. OpenCV Integration

- **Auto-initialization**: OpenCV.js loads automatically when the demo starts
- **Status indication**: "Cell Detect" button is disabled until OpenCV is ready
- **Browser console logging**: Shows initialization progress and detection results

### 2. Cell Detection Tool

- **Purple "Cell Detect" button** with Sparkles icon in the toolbar
- **Click-to-detect workflow**: Click anywhere on a cell to automatically detect its boundary
- **OpenCV flood fill algorithm**: Finds connected region from click point
- **Contour detection**: Extracts precise polygon boundary
- **Douglas-Peucker simplification**: Reduces polygon vertex count while preserving shape

### 3. Detection Parameters

The demo uses optimized parameters for cell detection:

```typescript
{
  threshold: 128,
  thresholdType: 'otsu',    // Automatic threshold selection
  minArea: 100,             // Filter small noise
  maxArea: 10000,           // Filter large regions
  morphOps: true,           // Clean up mask
}
```

### 4. Visual Feedback

- **Purple polygon overlay**: Detected cells shown with magenta/purple color (#FF00FF)
- **Semi-transparent fill**: 0.3 opacity to see underlying image
- **Stats panel updates**: Shows count of cell regions vs. point markers
- **Console logging**: Detailed detection info (point count, area, confidence)

### 5. Annotation Properties

Each detected cell includes metadata:

```typescript
{
  type: 'cell',
  area: 1234,              // Pixel area
  confidence: 0.85,        // Shape quality (0-1)
}
```

## Usage Workflow

1. **Wait for OpenCV**: Purple "Cell Detect" button becomes enabled when ready
2. **Select tool**: Click "Cell Detect" button in toolbar
3. **Click on cell**: Click inside any cell on the image
4. **View result**: Purple polygon appears showing detected boundary
5. **Repeat**: Click on other cells to detect multiple regions
6. **Switch tools**: Use "Pan" to navigate or "Point" to add markers

## Component Structure

```tsx
<DemoApp>
  ├── <OSDViewer>              // OpenSeadragon viewer
  ├── <OSDAnnotatorComponent>  // Annota rendering layer
  ├── <PointToolHandler>       // Point annotation tool
  ├── <ContourToolHandler>     // Cell detection tool
  ├── <Toolbar>                // Tool selector with OpenCV status
  ├── <ImageSelector>          // Image navigation
  └── <StatsPanel>             // Debug info and stats
```

## OpenCV Integration Pattern

```typescript
// 1. Initialize on mount
useEffect(() => {
  initOpenCV()
    .then(() => setOpencvReady(true))
    .catch(console.error);
}, []);

// 2. Check status before detection
if (!isOpenCVReady()) return;

// 3. Get ImageData from canvas
const canvas = viewer.drawer.canvas;
const ctx = canvas.getContext('2d');
const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

// 4. Detect cell edge
const result = detectCellEdge(imageData, imagePoint, options);

// 5. Create annotation
const annotation: Annotation = {
  id: `cell-${Date.now()}`,
  shape: {
    type: 'polygon',
    points: result.polygon,
    bounds: calculateBounds(result.polygon),
  },
  properties: {
    type: 'cell',
    confidence: result.confidence,
    area: result.area,
  },
};
```

## Future Enhancements (TODO)

### Threshold Adjustment

- Add slider to adjust detection threshold in real-time
- Preview detection before confirming
- Support binary/otsu/adaptive threshold modes

### Brush/Eraser Tools

- Manual refinement of detected cell boundaries
- Add/remove regions from mask
- Adjustable brush size

### Group Assignment

- Assign cells to groups (positive, negative, tumor, normal, etc.)
- Edit annotation properties in panel
- Color-code by group

### File I/O

- **Load H5**: Import point annotations from H5 files
- **Save H5**: Export point markers to H5 format
- **Load PGM**: Import region masks and convert to polygons
- **Save PGM**: Export cell polygons as binary masks

## Running the Demo

```bash
# From the annota root directory
cd examples/demo
pnpm install
pnpm dev
```

The demo will start on `http://localhost:5173` with hot-reload enabled.
